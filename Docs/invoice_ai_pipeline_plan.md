Вот итоговое саммари (резюме) всей архитектуры и логики, которую мы с вами разработали для автоматизации обработки счетов.

Это готовое техническое задание (ТЗ) для реализации.

### 1. Архитектура решения
* **Платформа:** **Yandex Cloud Functions (Serverless)**.
    * *Почему:* Работает 24/7, не требует аренды сервера, бесплатно (входит в free tier), идеально интегрируется с Яндекс.Диском.
* **Метод запуска:** **Поллинг по расписанию** (Trigger).
    * *Частота:* Каждые 5-10 минут.
    * *Логика очереди:* Обрабатываем **строго один файл за запуск**. Это гарантирует защиту от тайм-аутов и простоту логики при объеме ~150 документов в месяц.

### 2. Рабочий процесс (Пайплайн)
Скрипт выполняет следующие шаги при каждом запуске:

1.  **Сканирование:** Проверяет папку `/Входящие` на Яндекс.Диске.
2.  **Фильтрация:**
    * Если имя файла начинается на `000_` — **игнорирует** (считает черновиком/ошибкой).
    * Если имя нормальное (например, `333_...`) — берет **первый** файл в работу.
3.  **Определение типа:**
    * `JPG, PNG, PDF` (сканы) — отправляет файл целиком в мультимодальную LLM (GPT-4o с Vision).
    * `DOCX, XLSX` (текст) — извлекает чистый текст программно (`python-docx`, `pandas`) и отправляет в текстовую LLM (GPT-4 Turbo).
4.  **Обработка LLM:** Модель извлекает структурированные данные и возвращает строгий JSON с полной информацией:
    * **Документ:** Номер счета, дата выставления
    * **Получатель:** Банк, ИНН, КПП, название организации, БИК, корр. счет, расч. счет
    * **Покупатель:** Название, ИНН, КПП
    * **Логистика:** Грузополучатель, грузоотправитель
    * **Товары:** Массив с наименованием, ед. изм., количеством, ценой, суммой, ставкой НДС, суммой НДС
    * **Итоги:** Сумма без НДС, сумма НДС, итого к оплате
5.  **Сохранение данных:**
    * Разбирает JSON, "уплощает" его (превращает в список строк).
    * Добавляет строки в Google Sheets.
    * **Важно:** Добавляет столбец **"Статус"** со значением *"На проверку"* и **ссылку** на оригинал файла.
6.  **Архивация:**
    * Берет дату документа *из полученного JSON*.
    * Создает (если нет) структуру папок `/Обработанные/ГОД/МЕСЯЦ`.
    * Перемещает файл туда.
7.  **Обработка ошибок:** Если что-то сломалось, файл летит в папку `/Ошибки`.

### 3. Стек технологий (Python)
Список библиотек для `requirements.txt`:
* `yandex-disk` — управление файлами.
* `openai` — доступ к OpenAI API (GPT-4, GPT-4 Vision).
* `gspread` + `google-auth` — запись в Google Таблицы.
* `python-docx` — чтение Word.
* `pandas` + `openpyxl` — чтение Excel.
* `Pillow` — работа с изображениями.

### 3.1. Структура извлекаемых данных (JSON)

Полная структура JSON, которую возвращает LLM:

```json
{
  "document_info": {
    "invoice_number": "№ счета",
    "invoice_date": "ДД.ММ.ГГГГ"
  },
  "recipient_details": {
    "bank_name": "Банк получателя",
    "inn": "ИНН получателя (10 или 12 цифр)",
    "kpp": "КПП получателя (9 цифр)",
    "payee_name": "Наименование организации-получателя",
    "bic": "БИК (9 цифр)",
    "corr_account": "Корреспондентский счет (20 цифр)",
    "current_account": "Расчетный счет (20 цифр)"
  },
  "buyer_details": {
    "name": "Наименование покупателя",
    "inn": "ИНН покупателя",
    "kpp": "КПП покупателя"
  },
  "logistics": {
    "consignee": "Грузополучатель (полная строка)",
    "consignor": "Грузоотправитель (полная строка)"
  },
  "items": [
    {
      "name": "Наименование товара/услуги",
      "unit": "Единица измерения (шт, кг, м и т.д.)",
      "quantity": 10.5,
      "price_unit": 1500.00,
      "total_sum": 15750.00,
      "vat_rate": 20,
      "vat_amount": 3150.00
    }
  ],
  "totals": {
    "total_without_vat": 15750.00,
    "total_vat": 3150.00,
    "total_amount": 18900.00
  }
}
```

**Правила извлечения:**
* Если поле отсутствует — установить `null`.
* Даты приводить к формату `DD.MM.YYYY`.
* Числа очищать от пробелов и символов валют (`10 000,00` → `10000.00`).
* НДС может быть 0%, 10% или 20% (или null если не указан).

### 4. Обеспечение 100% достоверности
Мы не полагаемся на слепую автоматизацию, а строим систему **Human-in-the-Loop (Человек в контуре)**:

1.  **Уровень кода:** Расширенная автоматическая валидация:
    * Проверка формата даты (DD.MM.YYYY)
    * Валидация ИНН (10 или 12 цифр)
    * Математика для каждого товара:
      - `цена × количество = сумма` (±0.01 допуск)
      - `сумма × (ставка НДС / 100) = сумма НДС` (±0.01)
    * Проверка итоговых сумм документа:
      - `∑ всех сумм товаров = сумма без НДС`
      - `∑ всех НДС товаров = сумма НДС`
      - `сумма без НДС + сумма НДС = итого к оплате`
    * Проверка диапазонов (количество > 0, цена > 0, НДС ∈ [0, 20])

2.  **Уровень человека:**
    * Скрипт ставит статус *"На проверку"*.
    * Вы раз в день заходите в таблицу, кликаете на ссылку, сверяете и меняете статус на *"ОК"*.
    * Это занимает 5-10 минут, но дает 100% гарантию точности.

### 5. Ваши следующие шаги
1.  Получить **OAuth-токен Яндекс.Диска**.
2.  Получить **API-ключ OpenAI** (platform.openai.com).
3.  Настроить **биллинг и лимиты** в OpenAI Dashboard (рекомендуется установить monthly limit).
4.  Создать **Service Account** в Google Cloud для доступа к Таблицам.
5.  Написать код (собрать из фрагментов, что я давал) и файл `requirements.txt`.
6.  Загрузить всё это в **Yandex Cloud Function**.
7.  Настроить **Триггер** (таймер) на запуск каждые 10 минут.
8.  Увеличить тайм-аут функции в настройках до **60-120 секунд**.
9.  **Примерная стоимость:** ~$5-15/месяц для OpenAI API при объеме 150 документов.
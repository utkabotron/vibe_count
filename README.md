# Invoice AI Pipeline

Автоматическая система обработки бухгалтерских документов (счета, накладные, УПД) с использованием OpenAI API и интеграцией с Google Sheets.

## Возможности

- Автоматическое извлечение данных из документов (JPG, PNG, PDF, DOCX, XLSX)
- Использование GPT-4o Vision для обработки изображений
- Структурированный вывод в формате JSON
- Автоматическая валидация данных (математические проверки, НДС, итоги)
- Запись данных в Google Sheets с маркировкой "На проверку"
- Автоматическая архивация обработанных файлов на Яндекс.Диске
- Human-in-the-Loop для обеспечения 100% точности

## Архитектура

```
vibe_count/
├── src/
│   ├── __init__.py
│   ├── main.py              # Главный обработчик (точка входа)
│   ├── config.py            # Конфигурация и переменные окружения
│   ├── file_processor.py    # Работа с Яндекс.Диском
│   ├── llm_handler.py       # Интеграция с OpenAI API
│   ├── sheets_writer.py     # Запись в Google Sheets
│   └── validator.py         # Валидация данных
├── tests/                   # Unit-тесты
├── Docs/                    # Документация
├── Keys/                    # API ключи (не в git)
├── .env                     # Переменные окружения (не в git)
├── .env.example             # Шаблон переменных окружения
├── .gitignore
├── requirements.txt
└── README.md
```

## Установка

### 1. Клонирование репозитория

```bash
git clone https://github.com/utkabotron/vibe_count.git
cd vibe_count
```

### 2. Создание виртуального окружения

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 4. Настройка переменных окружения

Скопируйте `.env.example` в `.env` и заполните ключи:

```bash
cp .env.example .env
```

Отредактируйте `.env`:

```env
# Yandex Disk
YANDEX_OAUTH_TOKEN=your_token

# OpenAI API
OPENAI_API_KEY=your_key

# Google Sheets
GOOGLE_SHEETS_ID=your_sheet_id
GOOGLE_CREDENTIALS_PATH=path/to/credentials.json
```

### 5. Настройка Google Sheets

1. Создайте Service Account в Google Cloud Console
2. Скачайте JSON-ключ
3. Добавьте email Service Account в права доступа к таблице

### 6. Структура папок на Яндекс.Диске

Создайте следующие папки:
- `/Входящие` - для новых документов
- `/Обработанные` - архив обработанных файлов
- `/Ошибки` - документы с ошибками обработки

## Использование

### Локальный запуск

```bash
python src/main.py
```

### Развертывание в Yandex Cloud Functions

1. Упакуйте код в ZIP-архив:
```bash
zip -r function.zip src/ requirements.txt
```

2. Создайте функцию в Yandex Cloud Console
3. Загрузите ZIP-архив
4. Настройте переменные окружения
5. Установите точку входа: `src.main.handler`
6. Настройте триггер (Timer) на запуск каждые 5-10 минут

## Структура данных

Система извлекает следующие данные из документов:

### Информация о документе
- Номер счета
- Дата выставления

### Реквизиты получателя
- Банк
- ИНН, КПП
- Название организации
- БИК
- Корреспондентский счет
- Расчетный счет

### Реквизиты покупателя
- Название
- ИНН, КПП

### Логистика
- Грузополучатель
- Грузоотправитель

### Товары/Услуги
- Наименование
- Единица измерения
- Количество
- Цена за единицу
- Сумма
- Ставка НДС
- Сумма НДС

### Итоги
- Сумма без НДС
- Сумма НДС
- Итого к оплате

## Валидация

Система автоматически проверяет:

- Формат даты (DD.MM.YYYY)
- Формат ИНН (10 или 12 цифр)
- Математику для каждого товара: `цена × количество = сумма`
- Расчет НДС: `сумма × (ставка / 100) = сумма НДС`
- Итоговые суммы документа
- Диапазоны значений (количество > 0, цена > 0)

## Workflow

1. Система сканирует папку `/Входящие` каждые 5-10 минут
2. Берет первый файл (игнорирует файлы начинающиеся с `000_`)
3. Определяет тип файла и обрабатывает через OpenAI API
4. Валидирует извлеченные данные
5. Записывает в Google Sheets со статусом "На проверку"
6. Перемещает файл в `/Обработанные/ГОД/МЕСЯЦ` или `/Ошибки`

## Human-in-the-Loop

После автоматической обработки:
1. Откройте Google Sheets
2. Проверьте записи со статусом "На проверку"
3. Кликните на ссылку для просмотра оригинала
4. Сверьте данные
5. Измените статус на "ОК" если всё верно

## Стоимость

- **Yandex Cloud Functions:** Free Tier (до 1M вызовов/месяц)
- **OpenAI API:** ~$5-15/месяц при 150 документах
- **Google Sheets:** Бесплатно

## Разработка

### Запуск тестов

```bash
pytest tests/
```

### Структура модулей

- `main.py` - Главный обработчик, оркестрация всех компонентов
- `file_processor.py` - Работа с файлами на Яндекс.Диске
- `llm_handler.py` - Вызовы OpenAI API для извлечения данных
- `sheets_writer.py` - Запись данных в Google Sheets
- `validator.py` - Валидация извлеченных данных
- `config.py` - Загрузка конфигурации из .env

## Roadmap

- [ ] Реализация всех TODO в модулях
- [ ] Unit-тесты для каждого модуля
- [ ] Интеграционные тесты
- [ ] Обработка PDF с несколькими страницами
- [ ] Поддержка дополнительных форматов
- [ ] Webhooks для уведомлений
- [ ] Dashboard для мониторинга

## Лицензия

MIT

## Контакты

GitHub: [@utkabotron](https://github.com/utkabotron)
